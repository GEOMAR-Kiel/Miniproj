use serde::Deserialize;
use serde::de::DeserializeOwned;
use std::fmt::Debug;
use crate::net::get_cached;

/*
 * These types are named following the scheme in the epsg.org web api:
 * The trunk of the type name is cut off at "Models".
 * Dots are removed.
 * The name is prefixed with "Api".
 */

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiSearchResults {
    #[serde(rename = "Results", default)]
    pub results: Vec<ApiSearchResult>,
    #[serde(rename = "Count")]
    pub count: usize,
    #[serde(rename = "Page")]
    pub page: usize,
    #[serde(rename = "PageSize")]
    pub page_size: usize,
    #[serde(rename = "TotalResults")]
    pub total_results: usize,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiSearchResult {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Type", default)]
    pub result_type: String, //TODO: Replace by enum once fields are known.
    #[serde(rename = "DataSource", default)]
    pub data_source: String,
    #[serde(rename = "Area", default)]
    pub area: String,
    #[serde(rename = "Remarks")]
    pub remarks: Option<String>,
    #[serde(rename = "Deprecated")]
    pub deprecated: bool,
    #[serde(rename = "RevisionDate", default)]
    pub revision_date: String,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>
}
impl ApiSearchResult {
    pub fn get_results(endpoint: &str) -> Vec<Self> {
        let mut result = Vec::new();
        let mut pagenum = 0;
        let pagesize = 128;
        let mut pagemax;
        loop {
            let res: ApiSearchResults = serde_json::from_str(&get_cached(&format!("{}?page={}&pageSize={}", endpoint, pagenum, pagesize))).unwrap();
            pagemax = res.total_results / pagesize;
            result.extend(res.results);
            break result;
            if pagenum > pagemax {break result;}
            pagenum += 1;
        }
    }

    pub fn get_single_object<T>(&self) -> Option<T> where T: DeserializeOwned {
        ApiLink::rel_target(&self.links, "result")
    }
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub enum ApiEntryType {

}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiLink {
    pub rel: String,
    pub href: String
}
impl ApiLink {
    pub fn target<T>(&self) -> Option<T> where T: DeserializeOwned {
        Some(serde_json::from_str(&get_cached(&self.href)).unwrap())
    }
    
    pub fn rel_target<T>(links: &[Self], rel: &str) -> Option<T> where T: DeserializeOwned {
        links.iter().find(|e| e.rel == rel).and_then(|e| e.target())
    }
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiConversion {
    #[serde(rename = "ParameterValues", default)]
    pub parameter_values: Vec<ApiCoordOperationParamValue>,
    #[serde(rename = "Method")]
    pub method: ApiChildLink,
    #[serde(rename = "Usage", default)]
    pub usage: Vec<ApiUsage>,
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,
    #[serde(rename = "DataSource", default)]
    pub data_source: String,
    #[serde(rename = "InformationSource", default)]
    pub information_source: String,
    #[serde(rename = "RevisionDate", default)]
    pub revision_date: String,
    #[serde(rename = "Deprecations", default)]
    pub deprecations: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersessions", default)]
    pub supersessions: Vec<ApiEntitySupersession>
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiCoordOperationParamValue {
    #[serde(rename = "ParameterCode")]
    pub parameter_code: u32,
    #[serde(rename = "ParameterValue")]
    pub parameter_value: f64,
    #[serde(rename = "ParamValueFileRef")]
    pub param_value_file_ref: String,
    #[serde(rename = "Unit")]
    pub unit: ApiChildLink,
    #[serde(rename = "SignReversible")]
    pub sign_reversible: bool,
    #[serde(rename = "SortOrder")]
    pub sort_order: u32,
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,
    #[serde(rename = "DataSource", default)]
    pub data_source: String,
    #[serde(rename = "InformationSource", default)]
    pub information_source: String,
    #[serde(rename = "RevisionDate", default)]
    pub revision_date: String,
    #[serde(rename = "Deprecations", default)]
    pub deprecations: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersessions", default)]
    pub supersessions: Vec<ApiEntitySupersession>
}
impl ApiCoordOperationParamValue {
    fn get_value_normalized(&self) -> (f64, u32) {
        let u = self.unit.target::<ApiUnit>();
        (u.to_base_unit(self.parameter_value), u.target_unit.code)
    }

    fn get_value_normalized_from(source: &[Self], code: u32) -> (f64, u32) {
        source.iter().find(|e| e.code == code).unwrap().get_value_normalized()
    }

}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiCoordinateOperationParam {
    #[serde(rename = "MethodCode")]
    pub method_code: u32,
    #[serde(rename = "ParameterCode")]
    pub parameter_code: u32,
    #[serde(rename = "ParameterValue")]
    pub parameter_value: f64,
    #[serde(rename = "Unit")]
    pub parameter_unit: ApiChildLink,
    #[serde(rename = "Description", default)]
    pub description: String,
    #[serde(rename = "SortOrder")]
    pub sort_order: u32,
    #[serde(rename = "SignReverse")]
    pub sign_reverse: bool,
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,
    #[serde(rename = "DataSource", default)]
    pub data_source: String,
    #[serde(rename = "InformationSource", default)]
    pub information_source: String,
    #[serde(rename = "RevisionDate", default)]
    pub revision_date: String,
    #[serde(rename = "Deprecations", default)]
    pub deprecations: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersessions", default)]
    pub supersessions: Vec<ApiEntitySupersession>
}


#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiEntitySupersession {
    #[serde(rename = "SupersededBy")]
    pub superseded_by: ApiChildLink,
    #[serde(rename = "Year", default)]
    pub year: String,
    #[serde(rename = "Remarks", default)]
    pub remarks: String
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiEntityDeprecation {
    #[serde(rename = "Date", default)]
    pub date: String,
    #[serde(rename = "ChangeId")]
    pub change_id: f64,
    #[serde(rename = "ReplacedBy")]
    pub replaced_by: Option<ApiChildLink>,
    #[serde(rename = "Reason")]
    pub reason: String
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiAliasDetails {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Alias", default)]
    pub alias: String,
    #[serde(rename = "NamingSystem")]
    pub naming_system: ApiChildLink,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiChildLink {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Name", default)]
    pub name: String,
    pub href: String
}
impl ApiChildLink {
    pub fn target<T>(&self) -> T where T: DeserializeOwned {
        serde_json::from_str(&get_cached(&self.href)).unwrap()
    }
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiChildLink2 {
    #[serde(rename = "Code")]
    pub code: f64,
    #[serde(rename = "Name", default)]
    pub name: String,
    pub href: String
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiUsage {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "ScopeDetails", default)]
    pub scope_details: String,
    #[serde(rename = "Scope")]
    pub scope: ApiChildLink,
    #[serde(rename = "Extent")]
    pub extent: ApiChildLink,
    #[serde(rename = "Links")]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Deprecation", default)]
    pub deprecation: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersession", default)]
    pub supersession: Vec<ApiEntitySupersession>
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiEllipsoid {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "SemiMajorAxis")]
    pub semi_major_axis: Option<f64>,
    #[serde(rename = "SemiMinorAxis")]
    pub semi_minor_axis: Option<f64>,
    #[serde(rename = "InverseFlattening")]
    pub inverse_flattening: Option<f64>,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Deprecation", default)]
    pub deprecation: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersession", default)]
    pub supersession: Vec<ApiEntitySupersession>,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,
}
impl ApiEllipsoid {

    fn reformat_float_value(v: &Option<f64>) -> String {
        v.map(|v| format!("{}f64", v)).unwrap_or_else(|| "std::f64::NAN".into())
    }

    pub fn generate_match_line(&self) -> String {
        format!("const ellipsoid_{}: Ellipsoid = Ellipsoid::new({}, {}, {}).unwrap();",
            self.code,
            Self::reformat_float_value(&self.semi_major_axis),
            Self::reformat_float_value(&self.semi_minor_axis),
            Self::reformat_float_value(&self.inverse_flattening)
        )
    }

    pub fn generate_param_constructor_line(&self) -> String {
        format!("{} => Some(&ellipsoid_{}),",
            self.code,
            self.code
        )
    }
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiProjectedCoordRefSystem {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "BaseCoordRefSystem")]
    pub base_coord_ref_sytem: ApiChildLink,
    #[serde(rename = "Projection")]
    pub projection: ApiChildLink,
    //#[serde(rename = "Usage")]
    //pub usage: Vec<ApiUsage>,
    //#[serde(rename = "CoordSys")]
    //pub coord_sys: ApiChildLink,
    //#[serde(rename = "Kind")]
    //pub kind: String,
    //#[serde(rename = "Deformations", default)]
    //pub deformations: Vec<ApiChildLink>,
    //#[serde(rename = "Changes", default)]
    //pub changes: Vec<ApiChildLink2>,
    //#[serde(rename = "Alias", default)]
    //pub alias: Vec<ApiAliasDetails>,
    //#[serde(rename = "Links", default)]
    //pub links: Vec<ApiLink>,
    //#[serde(rename = "Name", default)]
    //pub name: String,
    //#[serde(rename = "Deprecation", default)]
    //pub deprecation: Vec<ApiEntityDeprecation>,
    //#[serde(rename = "Supersession", default)]
    //pub supersession: Vec<ApiEntitySupersession>,
    //#[serde(rename = "Remark")]
    //pub remark: Option<String>,
}
impl ApiProjectedCoordRefSystem {
    pub fn get_ellipsoid(&self) -> ApiEllipsoid {
        self.base_coord_ref_sytem.target::<ApiGeodeticCoordRefSystem>().datum.target::<ApiDatum>().ellipsoid.target::<ApiEllipsoid>()
    }

    pub fn get_projection_parameters(&self) -> Vec<ApiCoordOperationParamValue> {
        self.projection.target::<ApiConversion>().parameter_values
    }

    pub fn get_projection_method(&self) -> u32 {
        self.projection.target::<ApiConversion>().method.code
    }

    pub fn generate_match_line(&self, implemented_conversions: &[ImplementedConversion]) -> Option<String> {
        implemented_conversions.iter().find(|e| e.code == self.get_projection_method()).map(|conv| {
            format!("{} => ellipsoid_constructor({}).map(|e| Box::new({}::new(e, &op_{}_params)) as Box<dyn CoordTransform>)",
                self.code,
                self.get_ellipsoid().code,
                conv.conversion_type,
                self.code
            )
        })
    }

    pub fn generate_param_constructor_line(&self, implemented_conversions: &[ImplementedConversion]) -> Option<String> {
        implemented_conversions.iter().find(|e| e.code == self.get_projection_method()).map(|conv| {
                format!("const op_{}_params: {} = {}::new({});",
                self.code,
                conv.param_type,
                conv.param_type,
                {
                    let ps = self.get_projection_parameters();
                    conv.param_codes.iter().map(|&c| {
                        format!("{}, ", ApiCoordOperationParamValue::get_value_normalized_from(&ps, c).0)
                    }).collect::<String>()
                }
            )
        })
    }
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiGeodeticCoordRefSystem {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Datum")]
    pub datum: ApiChildLink,
    /*#[serde(rename = "Usage")]
    pub usage: ApiUsage,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Deprecation", default)]
    pub deprecation: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersession", default)]
    pub supersession: Vec<ApiEntitySupersession>,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,*/
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiDatum {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Ellipsoid")]
    pub ellipsoid: ApiChildLink,
    #[serde(rename = "PrimeMeridian")]
    pub prime_meridian: ApiChildLink,
    /*#[serde(rename = "Usage")]
    pub usage: ApiUsage,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Deprecation", default)]
    pub deprecation: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersession", default)]
    pub supersession: Vec<ApiEntitySupersession>,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,*/
}

#[derive(Debug, Deserialize, PartialEq, Clone)]
pub struct ApiUnit {
    #[serde(rename = "Code")]
    pub code: u32,
    #[serde(rename = "Type")]
    pub type_name: String,
    #[serde(rename = "TargetUnit")]
    pub target_unit: ApiChildLink,
    #[serde(rename = "FactorB")]
    pub factor_b: f64,
    #[serde(rename = "FactorC")]
    pub factor_c: f64,
    #[serde(rename = "Usage")]
    pub usage: ApiUsage,
    #[serde(rename = "Changes", default)]
    pub changes: Vec<ApiChildLink2>,
    #[serde(rename = "Alias", default)]
    pub alias: Vec<ApiAliasDetails>,
    #[serde(rename = "Links", default)]
    pub links: Vec<ApiLink>,
    #[serde(rename = "Name", default)]
    pub name: String,
    #[serde(rename = "Deprecation", default)]
    pub deprecation: Vec<ApiEntityDeprecation>,
    #[serde(rename = "Supersession", default)]
    pub supersession: Vec<ApiEntitySupersession>,
    #[serde(rename = "Remark")]
    pub remark: Option<String>,
}
impl ApiUnit {
    fn to_base_unit(&self, val: f64) -> f64 {
        val * self.factor_b / self.factor_c
    }
}

#[derive(Debug, PartialEq, Clone)]
pub struct ImplementedConversion {
    code: u32,
    param_codes: Vec<u32>,
    param_type: String,
    conversion_type: String
}
impl ImplementedConversion {
    pub fn new(code: u32, param_codes: &[u32], param_type: &str, conversion_type: &str) -> Self {
        Self {
            code,
            param_codes: param_codes.into(),
            param_type: param_type.into(),
            conversion_type: conversion_type.into()
        }
    }
}